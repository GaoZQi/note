# 项目2 单片机程序设计

## LED流水灯

### 实验要求

实现特定的7种LED流水灯显示效果。

### 实验代码

=== "led.c"

    ```c
    //////////////////////////////
    #include <stc8a.h>   //STC单片机特殊功能寄存器
    #include <intrins.h> //头文件含有_crol_和_cror_函数
    //////////////////////////////
    #define uchar unsigned char // 宏定义usigned char为uchar
    #define uint unsigned int   // 宏定义usigned int为uint
    //////////////////////////////按键定义
    sbit k1 = P3 ^ 2;
    sbit k2 = P3 ^ 3;
    sbit k3 = P3 ^ 4;
    sbit k4 = P3 ^ 5;
    sbit k5 = P4 ^ 0;
    sbit led = P4 ^ 0; // 流水灯开关，只有P4.1=0时，流水灯才能工作
    //////////////////////////////
    void delay_us(uint us) // 延时子程序
    {
        uint a; // 声明变量a的取值为0~65535
        uint b;
        for (b = 0; b < 4; b++)
            for (a = 0; a < us; a++)
                ; // 通过for循环实现延时
    }
    //////////////////////////////
    void start_1() // 第一题子程序名称start_1
    {
        uchar a, b; // 声明变量a和b的取值为0~255
        b = 0xfe;
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = b;           // b赋值给P0=11111110
            delay_us(50000);  // 调用延时子程序1秒
            b = _crol_(b, 1); // b=11111110左移一次后11111101
        }
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = b;           // b赋值给P0=11111101
            delay_us(50000);  // 调用延时子程序1秒
            b = _cror_(b, 1); // b=0111111右移一次后10111111
        }
    }
    //////////////////////////////
    void start_2() // 第二题子程序名称start_2
    {
        uchar a, b; // 声明变量a和b的取值为0~255
        b = 0xfe;
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = 0xe7 & b;    // 1110 0111与1111 1110按位与运算后1110 0110
            delay_us(50000);  // 调用延时子程序1秒
            b = _crol_(b, 1); // b=11111110左移一次后11111101
        }
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = 0xe7 & b;    // 1110 0111与0111 1111按位与运算后0110 0111
            delay_us(50000);  // 调用延时子程序1秒
            b = _cror_(b, 1); // b=0111111右移一次后10111111
        }
    }
    //////////////////////////////
    void start_3() // 第三题子程序名称start_3
    {
    }
    //////////////////////////////
    void main() // 主函数
    {
        led = 0;
        while (1)
        {
            start_1();
            start_2();
            // start_3();
        }
    }
    //////////////////////////////
    ```
=== "answer.c"

    ```c
    //////////////////////////////
    #include <stc8a.h>   //STC单片机特殊功能寄存器
    #include <intrins.h> //头文件含有_crol_和_cror_函数
    //////////////////////////////
    #define uchar unsigned char // 宏定义usigned char为uchar
    #define uint unsigned int   // 宏定义usigned int为uint
    //////////////////////////////按键定义
    sbit k1 = P3 ^ 2;
    sbit k2 = P3 ^ 3;
    sbit k3 = P3 ^ 4;
    sbit k4 = P3 ^ 5;
    sbit k5 = P4 ^ 0;
    sbit led = P4 ^ 0; // 流水灯开关，只有P4.1=0时，流水灯才能工作
    //////////////////////////////
    void delay_us(uint us) // 延时子程序
    {
        uint a; // 声明变量a的取值为0~65535
        uint b;
        for (b = 0; b < 4; b++)
            for (a = 0; a < us; a++)
                ; // 通过for循环实现延时
    }
    //////////////////////////////
    void start_1() // 第一题子程序名称start_1
    {
        uchar a, b; // 声明变量a和b的取值为0~255
        b = 0xfe;
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = b;           // b赋值给P0=11111110
            delay_us(50000);  // 调用延时子程序1秒
            b = _crol_(b, 1); // b=11111110左移一次后11111101
        }
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = b;           // b赋值给P0=11111101
            delay_us(50000);  // 调用延时子程序1秒
            b = _cror_(b, 1); // b=0111111右移一次后10111111
        }
    }
    //////////////////////////////
    void start_2() // 第二题子程序名称start_2
    {
        uchar a, b; // 声明变量a和b的取值为0~255
        b = 0xfe;
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = 0xe7 & b;    // 1110 0111与1111 1110按位与运算后1110 0110
            delay_us(50000);  // 调用延时子程序1秒
            b = _crol_(b, 1); // b=11111110左移一次后11111101
        }
        for (a = 0; a < 7; a++) // 循环7次
        {
            P0 = 0xe7 & b;    // 1110 0111与0111 1111按位与运算后0110 0111
            delay_us(50000);  // 调用延时子程序1秒
            b = _cror_(b, 1); // b=0111111右移一次后10111111
        }
    }
    //////////////////////////////
    void start_3() // 第三题子程序名称start_3
    {
        uchar l, r;
        uint i;
        r = 0xfe; // 1111 1110
        l = 0x7f; // 0111 1111
        for (i = 0; i < 7; i++)
        {
            P0 = r & l;
            delay_us(50000);
            r = _crol_(r, 1);
            l = _cror_(l, 1);
        }
    }
    //////////////////////////////
    void start_4()
    {
        uchar a = 0xff;
        uint i;
        for (i = 0; i < 8; i++)
        {
            P0 = a;
            delay_us(50000);
            a = a >> 1;
        }
        for (i = 0; i < 8; i++)
        {
            P0 = a;
            delay_us(50000);
            a = (a << 1) | 0x1;
        }
    }
    //////////////////////////////
    void start_5()
    {
        uchar a = 0xff;
        uint i, j;
        for (i = 8; i > 0; i--)
        {
            uint tmp = 0x7f;
            for (j = 0; j < i; j++)
            {
                P0 = a & tmp;
                delay_us(50000);
                tmp = tmp >> 1;
            }
            a = a << 1;
        }
    }
    //////////////////////////////
    void start_6()
    {
        uchar a = 0xff;
        uint i, j;
        for (i = 0; i < 8; i++)
        {
            uint tmp = 0x7f;
            for (j = 0; j < i; j++)
            {
                P0 = a & tmp;
                delay_us(50000);
                tmp = tmp >> 1;
            }
            a = a >> 1;
        }
    }
    //////////////////////////////
    void start_7()
    {
        uchar open = 0x00;
        uchar close = 0xff;

        uint time;
        uint i;

        while (1) // PWM调光循环
        {
            for (time = 0; time < 100; time++)
            {
                for (i = 0; i < 20; i++)
                {
                    P0 = open;
                    delay_us(time);
                    P0 = close;
                    delay_us(100 - time);
                }
            }
            for (time = 100; time > 0; time--)
            {
                for (i = 0; i < 20; i++)
                {
                    P0 = open;
                    delay_us(time);
                    P0 = close;
                    delay_us(100 - time);
                }
            }
        }
    }
    //////////////////////////////
    void main() // 主函数
    {
        led = 0;
        while (1)
        {
            start_1();
            start_2();
            start_3();
            start_4();
            start_5();
            start_6();
            start_7();
        }
    }
    //////////////////////////////
    ```