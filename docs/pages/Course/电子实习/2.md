# 项目2 单片机程序设计

## LED流水灯

### 实验要求

#### 任务一 流水灯

1. 实现特定的7种LED流水灯显示效果。

#### 任务二 电子表

1. P0口做数码管数据输出接口、P1口做数码管选择接口。
2. 在八位数码管上分别显示小时一分钟一秒，24小时制.
3. K1设置小时加，K2设置小时减，K3设置分钟加，K4设置分钟减。
4. K5切换模式，在时钟，日期和闹钟中切换。
5. 日期模式显示年.月.日；闹钟模式显示闹钟时间。

#### 任务三 交通灯

1. 利用单片机的定时器产生秒信号，控制十字路口的红、绿、黄灯交替点亮和熄灭，绿灯变红灯时,还剩4秒绿灯灭亮黄灯。
2. 用4只数码管显示十字路口两个方向的剩余时间。要求能用按键设置两个方向的通行时间（绿、红等点亮的时间），系统的工作应符合一般交通灯控制的要求。
3. 东西红绿灯：红灯=P2.2，黄灯=P2.1，绿灯=P2.0。 1点亮

    南北红绿灯：红灯=P2.5，黄灯=P2.4，绿灯=P2.3。 1点亮

### 实验代码

#### 程序框架模板

```c
#include <STC8A.h>
#define uchar unsigned char
#define uint unsigned int
uchar tabel[] = {0xc0, 0xf9, 0xa4, 0xb0, 0x99, 0x92,
                 0x82, 0xf8, 0x80, 0x90, 0xbf}; // 显示的数字数组，依次为0，1，2，3，4，5，6，7，8，9，-
uchar select[] = {0xfe, 0xfd, 0xfb, 0xf7, 0xef, 0xdf,0xbf,0x7f}; // 选择数码管数组，依次选择第1，2，3，4，5，6，7，8个数码管
///////////////////////////////////////////////按键定义
sbit k1 = P3 ^ 2;   //小时加
sbit k2 = P3 ^ 3;   //小时减
sbit k3 = P3 ^ 4;   //分钟加
sbit k4 = P3 ^ 5;   //分钟减
sbit k5 = P4 ^ 0;
sbit beep = P4 ^ 1;     //蜂鸣器
bit flag_beep;  //flag_beep=1时蜂鸣器发声，flag_beep=0时蜂鸣器关闭
///////////////////////////////////////////////标志位定义
bit flag1, flag2, flag3, flag4, flag5;
///////////////////////////////////////////////时间变量定义
uchar hour,minute.second;   //定义为有符号字符型变量
///////////////////////////////////////////////延迟函数，决定数码管跳变间隔时间
void delay()
{
    uint i=1000;
    while(i--);
}
///////////////////////////////////////////////初始化
void init()
{
    P0M1 = 0x00;    //设置P0，P1，P2推挽输出
    P0M0 = 0xff;
    P1M1 = 0x00;
    P1M0 = 0xff;
    P2M1 = 0x00;
    P2M0 = 0xff;
    /////////////////////////////////定时器T0初始化产生20毫秒@24.000MHz
    AUXR &= 0x7f;   //定时器时钟12T模式
    TMOD &= 0xf0;   //设置定时器模式
    TL0 = 0xC0;     //设置定时初值(65536-(24000000/12*0.02))%256
    TH0 = 0x63;     //设置定时初值(65536-(24000000/12*0.02))/256
    TR0 = 1;        //定时器0开始计时
    ET0 = 1;        //定时器T0中断允许
    EA = 1;         //开总中断
}
///////////////////////////////////////////////
void display() // 数码管显示子程序
{
    P1 = select[0];          // 选择第一个数码管
    P0 = tabel[second % 10]; // 显示秒个位
    delay();
    P1 = select[1];          // 选择第二个数码管
    P0 = tabel[second / 10]; // 显示秒十位
    delay();
    P1 = select[2]; // 选择第三个数码管
    P0 = tabel[10]; // 显示"-"
    delay();
}
///////////////////////////////////////////////
void set_time()
{   //这里按键应用不需要防抖延时，按键也不需要等待松开
    if(k1==0)
    {
        if(flag1==0)
        {
            flag1=1;
                        //这里填内容，你让按键做什么


        }
    }
    if(k1==1)
    {
        flag1=0;
    }
}
///////////////////////////////////////////////
void main() //主函数
{
    init(); //调用初始化
    P2=0X00;    //关闭交通灯
    while(1)
    {
        display();  //调用数码管显示
        set_time(); //调用时间设置
    }
}
///////////////////////////////////////////////
void timer0() interrupt 1   //定时器T0 20ms进入中断一次
{
    uchar t0,t1;
    t0++,t1++;
    if(t0==50)   //20ms*50=1s
    {
        t0=0;
        second++;
        if(second==60)
        {
            second=0;
                        //编写分钟和小时
        }
    }
    if(flag_beep==1)    //等于1时蜂鸣器300ms响一下
    {
        if(t1==15)  //20ms*15=300ms
        {
            t1=0;
            beep=~beep;
        }
    }
    else
    {
        beep=1;
    }
}
```

#### 任务一

```c
//////////////////////////////
#include <stc8a.h>   //STC单片机特殊功能寄存器
#include <intrins.h> //头文件含有_crol_和_cror_函数
//////////////////////////////
#define uchar unsigned char // 宏定义usigned char为uchar
#define uint unsigned int   // 宏定义usigned int为uint
//////////////////////////////按键定义
sbit k1 = P3 ^ 2;
sbit k2 = P3 ^ 3;
sbit k3 = P3 ^ 4;
sbit k4 = P3 ^ 5;
sbit k5 = P4 ^ 0;
sbit led = P4 ^ 0; // 流水灯开关，只有P4.1=0时，流水灯才能工作
//////////////////////////////
void delay_us(uint us) // 延时子程序
{
    uint a; // 声明变量a的取值为0~65535
    uint b;
    for (b = 0; b < 4; b++)
        for (a = 0; a < us; a++)
            ; // 通过for循环实现延时
}
//////////////////////////////
void start_1() // 第一题子程序名称start_1
{
    uchar a, b; // 声明变量a和b的取值为0~255
    b = 0xfe;
    for (a = 0; a < 7; a++) // 循环7次
    {
        P0 = b;           // b赋值给P0=11111110
        delay_us(50000);  // 调用延时子程序1秒
        b = _crol_(b, 1); // b=11111110左移一次后11111101
    }
    for (a = 0; a < 7; a++) // 循环7次
    {
        P0 = b;           // b赋值给P0=11111101
        delay_us(50000);  // 调用延时子程序1秒
        b = _cror_(b, 1); // b=0111111右移一次后10111111
    }
}
//////////////////////////////
void start_2() // 第二题子程序名称start_2
{
    uchar a, b; // 声明变量a和b的取值为0~255
    b = 0xfe;
    for (a = 0; a < 7; a++) // 循环7次
    {
        P0 = 0xe7 & b;    // 1110 0111与1111 1110按位与运算后1110 0110
        delay_us(50000);  // 调用延时子程序1秒
        b = _crol_(b, 1); // b=11111110左移一次后11111101
    }
    for (a = 0; a < 7; a++) // 循环7次
    {
        P0 = 0xe7 & b;    // 1110 0111与0111 1111按位与运算后0110 0111
        delay_us(50000);  // 调用延时子程序1秒
        b = _cror_(b, 1); // b=0111111右移一次后10111111
    }
}
//////////////////////////////
void start_3() // 第三题子程序名称start_3
{
    uchar l, r;
    uint i;
    r = 0xfe; // 1111 1110
    l = 0x7f; // 0111 1111
    for (i = 0; i < 7; i++)
    {
        P0 = r & l;
        delay_us(50000);
        r = _crol_(r, 1);
        l = _cror_(l, 1);
    }
}
//////////////////////////////
void start_4()
{
    uchar a = 0xff;
    uint i;
    for (i = 0; i < 8; i++)
    {
        P0 = a;
        delay_us(50000);
        a = a >> 1;
    }
    for (i = 0; i < 8; i++)
    {
        P0 = a;
        delay_us(50000);
        a = (a << 1) | 0x1;
    }
}
//////////////////////////////
void start_5()
{
    uchar a = 0xff;
    uint i, j;
    for (i = 8; i > 0; i--)
    {
        uint tmp = 0x7f;
        for (j = 0; j < i; j++)
        {
            P0 = a & tmp;
            delay_us(50000);
            tmp = tmp >> 1;
        }
        a = a << 1;
    }
}
//////////////////////////////
void start_6()
{
    uchar a = 0xff;
    uint i, j;
    for (i = 0; i < 8; i++)
    {
        uint tmp = 0x7f;
        for (j = 0; j < i; j++)
        {
            P0 = a & tmp;
            delay_us(50000);
            tmp = tmp >> 1;
        }
        a = a >> 1;
    }
}
//////////////////////////////
void start_7()
{
    uchar open = 0x00;
    uchar close = 0xff;

    uint time;
    uint i;

    while (1) // PWM调光循环
    {
        for (time = 0; time < 100; time++)
        {
            for (i = 0; i < 20; i++)
            {
                P0 = open;
                delay_us(time);
                P0 = close;
                delay_us(100 - time);
            }
        }
        for (time = 100; time > 0; time--)
        {
            for (i = 0; i < 20; i++)
            {
                P0 = open;
                delay_us(time);
                P0 = close;
                delay_us(100 - time);
            }
        }
    }
}
//////////////////////////////
void main() // 主函数
{
    led = 0;
    while (1)
    {
        start_1();
        start_2();
        start_3();
        start_4();
        start_5();
        start_6();
        start_7();
    }
}
//////////////////////////////
```

#### 任务二

```c
#include <STC8A.h>
#define uchar unsigned char
#define uint unsigned int
uchar tabel[] = {0xc0, 0xf9, 0xa4, 0xb0, 0x99, 0x92,
                 0x82, 0xf8, 0x80, 0x90, 0xbf};                    // 显示的数字数组，依次为0，1，2，3，4，5，6，7，8，9，-
uchar select[] = {0xfe, 0xfd, 0xfb, 0xf7, 0xef, 0xdf, 0xbf, 0x7f}; // 选择数码管数组，依次选择第1，2，3，4，5，6，7，8个数码管
uchar dot[] = {0x40, 0x79, 0x24, 0x30, 0x19, 0x12,
               0x02, 0x78, 0x00, 0x10, 0x3f}; // 显示小数点
///////////////////////////////////////////////按键定义
sbit k1 = P3 ^ 2; // 小时加
sbit k2 = P3 ^ 3; // 小时减
sbit k3 = P3 ^ 4; // 分钟加
sbit k4 = P3 ^ 5; // 分钟减
sbit k5 = P4 ^ 0;
sbit beep = P4 ^ 1; // 蜂鸣器
bit flag_beep;      // flag_beep=1时蜂鸣器发声，flag_beep=0时蜂鸣器关闭
///////////////////////////////////////////////标志位定义
bit flag1, flag2, flag3, flag4, flag5;
///////////////////////////////////////////////时间常量定义
//TODO 自动同步系统时间
#define YEAR 2023
#define MONTH 9
#define DAY 6
#define HOUR 9
#define MINUTE 54
#define SECOND 0

#define ALR_HOUR 9
#define ALR_MINUTE 54
///////////////////////////////////////////////时间变量定义
char hour = HOUR, minute = MINUTE, second = SECOND;                 // 定义为有符号字符型变量
int day = DAY, month = MONTH, year = YEAR;                          // 定义为有符号整型变量
int alr_hour = ALR_HOUR, alr_minute = ALR_MINUTE;                   // 闹钟时间
int month_day[] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31}; // 每月天数
//TODO 闰年支持
uint mode = 0; // 模式选择
///////////////////////////////////////////////延迟函数，决定数码管跳变间隔时间
void delay()
{
    uint i = 1000;
    while (i--)
        ;
}
///////////////////////////////////////////////初始化
void init()
{
    P0M1 = 0x00; // 设置P0，P1，P2推挽输出
    P0M0 = 0xff;
    P1M1 = 0x00;
    P1M0 = 0xff;
    P2M1 = 0x00;
    P2M0 = 0xff;
    /////////////////////////////////定时器T0初始化产生20毫秒@24.000MHz
    AUXR &= 0x7f; // 定时器时钟12T模式
    TMOD &= 0xf0; // 设置定时器模式
    TL0 = 0xC0;   // 设置定时初值(65536-(24000000/12*0.02))%256
    TH0 = 0x63;   // 设置定时初值(65536-(24000000/12*0.02))/256
    TR0 = 1;      // 定时器0开始计时
    ET0 = 1;      // 定时器T0中断允许
    EA = 1;       // 开总中断
}
///////////////////////////////////////////////
void mode_select()
{
    if (k5 == 0)
    {
        if (flag5 == 0)
        {
            flag5 = 1;
            mode = (mode + 1) % 3;
        }
    }
    if (k5 == 1)
    {
        flag5 = 0;
    }
}
///////////////////////////////////////////////
void display() // 数码管显示子程序
{
    P1 = select[0];          // 选择第一个数码管
    P0 = tabel[second % 10]; // 显示秒个位
    delay();
    P1 = select[1];          // 选择第二个数码管
    P0 = tabel[second / 10]; // 显示秒十位
    delay();

    P1 = select[2]; // 选择第三个数码管
    P0 = tabel[10]; // 显示"-"
    delay();

    P1 = select[3];          // 选择第四个数码管
    P0 = tabel[minute % 10]; // 显示分个位
    delay();
    P1 = select[4];          // 选择第五个数码管
    P0 = tabel[minute / 10]; // 显示分十位
    delay();

    P1 = select[5]; // 选择第六个数码管
    P0 = tabel[10]; // 显示"-"
    delay();

    P1 = select[6];        // 选择第七个数码管
    P0 = tabel[hour % 10]; // 显示时个位
    delay();
    P1 = select[7];        // 选择第八个数码管
    P0 = tabel[hour / 10]; // 显示时十位
    delay();
}
///////////////////////////////////////////////
// XXX set函数中正负溢出写的很烂
void set_time()
{ // 这里按键应用不需要防抖延时，按键也不需要等待松开
    if (k1 == 0)
    {
        if (flag1 == 0)
        {
            flag1 = 1;
            hour++;
        }
    }
    if (k1 == 1)
    {
        flag1 = 0;
    }

    if (k2 == 0)
    {
        if (flag2 == 0)
        {
            flag2 = 1;
            hour--;
        }
    }
    if (k2 == 1)
    {
        flag2 = 0;
    }
    ///////////////////////////////////////////////
    if (k3 == 0)
    {
        if (flag3 == 0)
        {
            flag3 = 1;
            minute++;
        }
    }
    if (k3 == 1)
    {
        flag3 = 0;
    }

    if (k4 == 0)
    {
        if (flag4 == 0)
        {
            flag4 = 1;
            minute--;
        }
    }
    if (k4 == 1)
    {
        flag4 = 0;
    }
    ///////////////////////////////////////////////
    if (minute >= 60)
    {
        hour += minute / 60;
        minute %= 60;
    }
    if (minute < 0)
    {
        hour--;
        minute = 59;
    }
    if (hour >= 24)
    {
        hour = 0;
        day++;
    }
    if (hour < 0)
    {
        hour = 23;
        day--;
    }
}
////////////////////////////////////////////////
void dispaly_date()
{
    P1 = select[0];
    P0 = tabel[day % 10];
    delay();
    P1 = select[1];
    P0 = tabel[day / 10];
    delay();

    P1 = select[2];
    P0 = dot[month % 10];
    delay();
    P1 = select[3];
    P0 = tabel[month / 10];
    delay();

    P1 = select[4];
    P0 = dot[year % 10];
    delay();
    P1 = select[5];
    P0 = tabel[year % 100 / 10];
    delay();
    P1 = select[6];
    P0 = tabel[year / 100 % 10];
    delay();
    P1 = select[7];
    P0 = tabel[year / 1000];
    delay();
}
///////////////////////////////////////////////
void set_date()
{
    if (k1 == 0)
    {
        if (flag1 == 0)
        {
            flag1 = 1;
            month++;
            if (day > month_day[month])
            {
                day = month_day[month];
            }
        }
    }
    if (k1 == 1)
    {
        flag1 = 0;
    }

    if (k2 == 0)
    {
        if (flag2 == 0)
        {
            flag2 = 1;
            month--;
            if (month <= 0)
            {
                month = 12;
                year--;
            }
            if (day > month_day[month])
            {
                day = month_day[month];
            }
        }
    }
    if (k2 == 1)
    {
        flag2 = 0;
    }
    ///////////////////////////////////////////////
    if (k3 == 0)
    {
        if (flag3 == 0)
        {
            flag3 = 1;
            day++;
        }
    }
    if (k3 == 1)
    {
        flag3 = 0;
    }

    if (k4 == 0)
    {
        if (flag4 == 0)
        {
            flag4 = 1;
            day--;
        }
    }
    if (k4 == 1)
    {
        flag4 = 0;
    }
    ///////////////////////////////////////////////
    if (day > month_day[month])
    {
        month++;
        day = 1;
    }
    if (day <= 0)
    {
        month--;
        if (month <= 0)
        {
            month = 12;
            year--;
        }
        day = month_day[month];
    }
    if (month > 12)
    {
        month = 1;
        year++;
    }
    if (month <= 0)
    {
        month = 12;
        year--;
    }
}
////////////////////////////////////////////////
void dispaky_alarm()
{
    P1 = select[3];
    P0 = tabel[alr_minute % 10];
    delay();
    P1 = select[4];
    P0 = tabel[alr_minute / 10];
    delay();

    P1 = select[5];
    P0 = tabel[10];
    delay();

    P1 = select[6];
    P0 = tabel[alr_hour % 10];
    delay();
    P1 = select[7];
    P0 = tabel[alr_hour / 10];
    delay();
}
///////////////////////////////////////////////
void set_alarm()
{
    if (k1 == 0)
    {
        if (flag1 == 0)
        {
            flag1 = 1;
            alr_hour++;
        }
    }
    if (k1 == 1)
    {
        flag1 = 0;
    }

    if (k2 == 0)
    {
        if (flag2 == 0)
        {
            flag2 = 1;
            alr_hour--;
        }
    }
    if (k2 == 1)
    {
        flag2 = 0;
    }

    if (k3 == 0)
    {
        if (flag3 == 0)
        {
            flag3 = 1;
            alr_minute++;
        }
    }
    if (k3 == 1)
    {
        flag3 = 0;
    }

    if (k4 == 0)
    {
        if (flag4 == 0)
        {
            flag4 = 1;
            alr_minute--;
        }
    }
    if (k4 == 1)
    {
        flag4 = 0;
    }

    if (alr_minute >= 60)
    {
        alr_hour += alr_minute / 60;
        alr_minute %= 60;
    }
    if (alr_minute < 0)
    {
        alr_hour--;
        alr_minute = 59;
    }
    if (alr_hour >= 24)
    {
        alr_hour = 0;
    }
    if (alr_hour < 0)
    {
        alr_hour = 23;
    }
}
////////////////////////////////////////////////
void alarm()
{
    if (hour == alr_hour && minute == alr_minute)
    {
        flag_beep = 1;
    }
    else
    {
        flag_beep = 0;
    }
}
////////////////////////////////////////////////
void main() // 主函数
{
    init();    // 调用初始化
    P2 = 0X00; // 关闭交通灯
    mode = 0;
    while (1)
    {
        mode_select();
        alarm();
        if (mode == 0)
        {
            display();
            set_time();
        }
        if (mode == 1)
        {
            dispaly_date();
            set_date();
        }
        if (mode == 2)
        {
            dispaky_alarm();
            set_alarm();
        }
    }
}
///////////////////////////////////////////////
void timer0() interrupt 1 // 定时器T0 20ms进入中断一次
{
    uchar t0, t1;
    t0++, t1++;
    if (t0 == 50) // 20ms*50=1s
    {
        t0 = 0;
        second++;
        if (second == 60)
        {
            second = 0;
            minute++;
        }
        if (minute == 60)
        {
            minute = 0;
            hour++;
        }
        if (hour == 24)
        {
            hour = 0;
            day++;
        }
        if (day == month_day[month])
        {
            day = 0;
            month++;
        }
        if (month > 12)
        {
            month = 1;
            year++;
        }
    }
    if (flag_beep == 1) // 等于1时蜂鸣器300ms响一下
    {
        if (t1 == 15) // 20ms*15=300ms
        {
            t1 = 0;
            beep = ~beep;
        }
    }
    else
    {
        beep = 1;
    }
}
```

#### 任务三（略）

可参考[电子实习项目5-物联网智慧交通实验](5.md)
